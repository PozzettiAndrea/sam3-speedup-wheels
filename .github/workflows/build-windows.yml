name: Build Windows Wheels

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    strategy:
      fail-fast: false
      matrix:
        package: [torch_generic_nms, cc_torch]
        include:
          # CUDA 12.4 + PyTorch 2.5.1
          - cuda: '12.4'
            pytorch: '2.5.1'
            python: '3.10'
          - cuda: '12.4'
            pytorch: '2.5.1'
            python: '3.11'
          - cuda: '12.4'
            pytorch: '2.5.1'
            python: '3.12'
          # CUDA 12.6 + PyTorch 2.6.0
          - cuda: '12.6'
            pytorch: '2.6.0'
            python: '3.10'
          - cuda: '12.6'
            pytorch: '2.6.0'
            python: '3.11'
          - cuda: '12.6'
            pytorch: '2.6.0'
            python: '3.12'
          - cuda: '12.6'
            pytorch: '2.6.0'
            python: '3.13'
          # CUDA 12.6 + PyTorch 2.8.1
          - cuda: '12.6'
            pytorch: '2.8.1'
            python: '3.10'
          - cuda: '12.6'
            pytorch: '2.8.1'
            python: '3.11'
          - cuda: '12.6'
            pytorch: '2.8.1'
            python: '3.12'
          - cuda: '12.6'
            pytorch: '2.8.1'
            python: '3.13'
          # CUDA 12.8 + PyTorch 2.8.1
          - cuda: '12.8'
            pytorch: '2.8.1'
            python: '3.10'
          - cuda: '12.8'
            pytorch: '2.8.1'
            python: '3.11'
          - cuda: '12.8'
            pytorch: '2.8.1'
            python: '3.12'
          - cuda: '12.8'
            pytorch: '2.8.1'
            python: '3.13'
          # CUDA 12.8 + PyTorch 2.9.1
          - cuda: '12.8'
            pytorch: '2.9.1'
            python: '3.10'
          - cuda: '12.8'
            pytorch: '2.9.1'
            python: '3.11'
          - cuda: '12.8'
            pytorch: '2.9.1'
            python: '3.12'
          - cuda: '12.8'
            pytorch: '2.9.1'
            python: '3.13'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Get CUDA version info
        id: cuda
        shell: bash
        run: |
          CUDA_VER="${{ matrix.cuda }}"
          CUDA_NODOT=$(echo $CUDA_VER | tr -d '.')
          echo "version=$CUDA_VER" >> $GITHUB_OUTPUT
          echo "version_nodot=$CUDA_NODOT" >> $GITHUB_OUTPUT

      - name: Install CUDA toolkit
        shell: powershell
        run: |
          $CUDA_VERSION = "${{ matrix.cuda }}"
          $CUDA_VERSION_FULL = switch ($CUDA_VERSION) {
            "12.4" { "12.4.1" }
            "12.6" { "12.6.3" }
            "12.8" { "12.8.1" }
          }

          Write-Host "Installing CUDA $CUDA_VERSION_FULL"

          # Download CUDA installer - use exact URLs from NVIDIA
          $installerUrl = switch ($CUDA_VERSION) {
            "12.4" { "https://developer.download.nvidia.com/compute/cuda/12.4.1/local_installers/cuda_12.4.1_551.78_windows.exe" }
            "12.6" { "https://developer.download.nvidia.com/compute/cuda/12.6.3/local_installers/cuda_12.6.3_561.17_windows.exe" }
            "12.8" { "https://developer.download.nvidia.com/compute/cuda/12.8.1/local_installers/cuda_12.8.1_572.61_windows.exe" }
          }

          Write-Host "Downloading from $installerUrl"
          Invoke-WebRequest -Uri $installerUrl -OutFile "cuda_installer.exe" -UseBasicParsing

          # Install silently - only nvcc and cudart (what we need for building)
          Write-Host "Installing CUDA toolkit..."
          Start-Process -FilePath "cuda_installer.exe" -ArgumentList "-s", "nvcc_$CUDA_VERSION_FULL", "cudart_$CUDA_VERSION_FULL", "visual_studio_integration_$CUDA_VERSION_FULL" -Wait -NoNewWindow

          # Add to PATH
          $cudaPath = "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v$CUDA_VERSION"
          echo "$cudaPath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "CUDA_HOME=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "CUDA_PATH=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Install PyTorch
        shell: bash
        run: |
          CUDA_TAG="cu${{ steps.cuda.outputs.version_nodot }}"
          pip install torch==${{ matrix.pytorch }}+${CUDA_TAG} --index-url https://download.pytorch.org/whl/${CUDA_TAG}
          pip install wheel setuptools ninja

      - name: Verify setup
        run: |
          nvcc --version
          python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA: {torch.version.cuda}')"

      - name: Clone torch_generic_nms
        if: matrix.package == 'torch_generic_nms'
        run: git clone https://github.com/ronghanghu/torch_generic_nms.git

      - name: Clone cc_torch
        if: matrix.package == 'cc_torch'
        run: git clone https://github.com/ronghanghu/cc_torch.git

      - name: Build wheel
        shell: cmd
        run: |
          cd ${{ matrix.package }}
          set TORCH_CUDA_ARCH_LIST=7.5;8.6;8.9;9.0;10.0
          python setup.py bdist_wheel
          dir dist

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package }}-windows-cu${{ steps.cuda.outputs.version_nodot }}-torch${{ matrix.pytorch }}-py${{ matrix.python }}
          path: ${{ matrix.package }}/dist/*.whl
          retention-days: 90

  collect:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: wheels
          merge-multiple: true

      - name: List all wheels
        run: find wheels -name "*.whl" -type f | sort

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-windows-wheels
          path: wheels/*.whl
          retention-days: 90
